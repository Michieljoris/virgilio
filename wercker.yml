box: wercker/nodejs
build:
  steps:
    - npm-install
    - npm-test
deploy:
  steps:
    - script:
        name: setup npmrc
        code: echo "_auth = $NPM_KEY" >> ~/.npmrc; echo "email = $NPM_EMAIL" >> ~/.npmrc
    - script:
        name: npm publish
        code: npm publish
  after-steps:
    - npm-install
    - script:
        name: install gulp globally
        code: sudo npm install -g gulp
    - script:
        name: publish docs
        code: |-
          gulp docs
          cd documentation
          mv virgilio.html index.html
          git config --global user.email $GITHUB_EMAIL
          git config --global user.name 'Virgilio'
          git init
          git add .
          git commit -m "Publishing annotated source code."
          git push --force $GITHUB_REMOTE master:gh-pages
    - script:
        name: check code coverage
        code: |-
            gulp coverage
            sudo npm install -g codeclimate-test-reporter
            codeclimate < coverage/lcov.info
